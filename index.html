<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saavr App v3.4</title>
  <style>
    :root {
      --mint:#50C3A3;
      --dark:#1E2428;
      --card:#252C31;
      --muted:#9BA6AD;
      --line:#2F3940;
      --danger:#FF6B6B;
      --ringbg:#2A3237;
      --shadow: rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;}
    body{background:var(--dark);color:#E9F2F0;min-height:100vh;display:flex;flex-direction:column;}
    .hidden{display:none!important;}
/* Keep month navigation arrows fixed and centered */
#month-nav {
  justify-content: center;
}

#month-display {
  display: inline-block;
  min-width: 140px;   /* Adjust for longer month names */
  text-align: center;
}
 #month-nav button:disabled {
  opacity: 0.4;            /* faint look */
  cursor: not-allowed;     /* shows it's inactive */
  filter: grayscale(100%);
}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#222A2F;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10;}
    header h1{color:var(--mint);font-size:18px;letter-spacing:.3px;}
    .container{flex:1;overflow:auto;padding:14px 16px 84px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 8px 16px var(--shadow);}
    .card h2{font-size:16px;margin-bottom:8px;color:#E9F2F0;}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .right{margin-left:auto;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;}
    .primary{background:var(--mint);color:rgb(9,48,39);}
    .outline{background:transparent;border:2px solid var(--mint);color:var(--mint);}
    .ghost{background:transparent;color:var(--mint);font-weight:600;}
    .small{padding:6px 10px;border-radius:8px;font-size:12px;}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;}
    input, select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#2B3338;color:#E6F2F0;}

    /* Login (v2 style) */
    #login{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:14px;text-align:center;}
    #login .panel{width:min(480px,92%);background:#232A2E;border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 12px 24px var(--shadow);}
    #login h1{color:var(--mint);font-size:34px;text-shadow:0 0 18px rgba(80,195,163,.35);}
    .error{color:var(--danger);font-size:13px;margin-top:6px;}

    /* Donut + progress */
    .donut-wrap{position:relative;width:260px;height:260px;margin:8px auto;}
    .donut-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;font-weight:800;font-size:20px;text-shadow:0 2px 10px rgba(0,0,0,.4);}
    .center-positive{color:var(--mint);}
    .center-negative{color:var(--danger);}

    .progress-wrap{width:92%;max-width:520px;margin:8px auto 0;background:#1f262a;border:1px solid #2f3a3f;border-radius:999px;overflow:hidden;}
    .progress-fill{height:18px;background:var(--mint);}
    .progress-fill.danger {background: var(--danger);}
    .progress-label{margin-top:6px;text-align:center;color:var(--muted);font-weight:700;}

    /* Tooltip */
    .tooltip{position:fixed;z-index:1000;pointer-events:none;background:rgba(22,27,31,.92);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border:1px solid #3A454C;border-radius:10px;padding:10px 12px;box-shadow:0 10px 20px var(--shadow);color:#EAF2F0;opacity:0;transform:translateY(-6px);transition:opacity .15s ease, transform .15s ease;}
    .tooltip.visible{opacity:1;transform:translateY(0);}
    .tooltip .title{font-weight:700;margin-bottom:4px;color:#EAF2F0;}
    .tooltip .row{justify-content:space-between;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(80,195,163,.12);border:1px solid rgba(80,195,163,.35);color:var(--mint);font-size:11px;font-weight:700;}

    /* Category / Transaction rows */
    .cat-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#20272B;margin-bottom:10px;border:1px solid #30383E;}
    .cat-item.overspent{background: rgba(255,107,107,0.12);border-color: rgba(255,107,107,0.55);}
    .swatch{width:18px;height:18px;border-radius:5px;border:2px solid #101416;box-shadow:0 1px 2px var(--shadow);}
    .cat-name{font-weight:600;}
    .cat-amount{color:#CFE1DE;font-weight:700;}
    .cat-actions{display:flex;gap:6px;align-items:center;}

    nav{position:fixed;bottom:0;left:0;right:0;background:#222A2F;border-top:1px solid var(--line);display:flex;justify-content:space-around;padding:8px 4px 10px;z-index:5;}
    nav button{background:transparent;border:none;color:#9AA7AD;font-weight:600;padding:6px 8px;border-radius:8px;}
    nav button.active{color:var(--mint);background:rgba(80,195,163,.12);}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:20;}
    .modal{background:#22313A;border:1px solid #37474F;border-radius:14px;width:min(520px,92%);padding:14px;box-shadow:0 16px 32px var(--shadow);}
    .modal h3{margin-bottom:8px;color:#E9F2F0;}
    .modal .row{margin-top:8px;}
  </style>
</head>
<body>
  <!-- Tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <!-- LOGIN -->
  <section id="login">
    <div class="panel">
      <h1>Saavr</h1>
      <p style="color:var(--muted);margin-top:6px;">Sign in to manage your budget and accounts</p>
      <div style="height:10px;"></div>
      <label for="u">Username</label>
      <input id="u" type="text" placeholder="admin" autocomplete="username">
      <div style="height:8px;"></div>
      <label for="p">Password</label>
      <input id="p" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      <p id="login-err" class="error hidden">Invalid username or password.</p>
      <div style="height:10px;"></div>
      <button id="login-btn" class="btn primary" style="width:100%;">Login</button>
      <p style="color:var(--muted);margin-top:8px;">Demo ‚Üí <b>admin</b> / <b>1234</b></p>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <header><h1>Dashboard</h1><div>‚öôÔ∏è</div></header>
    <div class="container">
      <div class="card">
        <div class="row">
          <h2>Accounts</h2>
          <button class="btn ghost right" onclick="showPage('accounts')">Open Accounts ‚Üí</button>
        </div>
        <p style="color:var(--muted);margin-top:6px;">Manage transactions and categories in Accounts & Budget tabs.</p>
      </div>

      <div class="card">
        <div class="row" style="align-items:baseline;">
          <h2>Budget <span id="dash-month" style="color:#8fd6c3;font-weight:700;"></span></h2>
          <button class="btn ghost right" onclick="showPage('budget')">View Budget ‚Üí</button>
        </div>
        <div class="donut-wrap">
          <svg id="dash-donut" width="260" height="260"></svg>
          <div id="dash-center" class="donut-center">$0</div>
        </div>
        <!-- Dashboard progress bar beneath donut -->
        <div class="progress-wrap">
          <div id="dash-progress" class="progress-fill" style="width:0%;"></div>
        </div>
        <div id="dash-progress-label" class="progress-label">$0 / $0 spent</div>
      </div>
    </div>
    <nav>
      <button class="active" onclick="showPage('dashboard')">üè† Dashboard</button>
      <button onclick="showPage('budget')">üí∞ Budget</button>
      <button onclick="showPage('accounts')">üè¶ Accounts</button>
      <button disabled>üìà Insights</button>
      <button disabled>üë§ Profile</button>
    </nav>
  </section>

  <!-- BUDGET -->
  <section id="budget" class="hidden">
    <header>
      <h1>Budget</h1>
    </header>
<div class="container">
  <div class="card">
    <h2>Monthly Income</h2>
    <div class="row">
      <div style="flex:1;min-width:180px;">
        <label>Total Income</label>
        <div id="income-total" style="font-weight:700;font-size:16px;color:var(--mint);">$0</div>
      </div>
      <div class="right">
        <button class="btn primary" id="add-income-btn">+ Add Income</button>
        <button class="btn ghost right" onclick="openEditIncomeModal()">Edit Income ‚Üí</button>
      </div>
    </div> <!-- ‚úÖ closes .row -->

    <!-- üü¢ Income Received Progress Bar -->
    <div class="progress-wrap" style="margin-top:12px;">
      <div id="income-progress" class="progress-fill" style="width:0%;background:#60A5FA;"></div>
    </div>
    <div id="income-progress-label" class="progress-label">0% of income received</div>

  </div> <!-- ‚úÖ closes .card -->

      <div class="card">
        <div class="row" style="align-items:baseline;">
        <h2>Overview</h2>
<div class="right" id="month-nav" style="display:flex;align-items:center;gap:8px;">
  <button id="prev-month" class="btn ghost small" style="padding:4px 8px;">‚óÄ</button>
  <span id="month-display" style="font-weight:700;color:#8fd6c3;">Month Year</span>
  <button id="next-month" class="btn ghost small" style="padding:4px 8px;">‚ñ∂</button>
</div>
  </div>
        <div class="donut-wrap">
          <svg id="budget-donut" width="260" height="260"></svg>
          <div id="budget-center" class="donut-center">$0</div>
        </div>
        <!-- Budget progress bar beneath donut -->
        <div class="progress-wrap">
          <div id="budget-progress" class="progress-fill" style="width:0%;"></div>
        </div>
        <div id="budget-progress-label" class="progress-label">$0 / $0 spent</div>
      </div>

      <div class="card">
        <h2>Create Category</h2>
        <div class="row">
          <div style="flex:1;min-width:180px;">
            <label for="cat-select">Category</label>
            <select id="cat-select"></select>
          </div>
          <div style="flex:1;min-width:140px;">
            <label for="cat-amount">Budget ($)</label>
            <input id="cat-amount" type="number" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="add-cat">+ Add</button>
          </div>
        </div>
        <p id="add-error" class="error hidden" style="margin-top:8px;"></p>
        <p style="color:var(--muted);margin-top:6px;">Preset color is assigned automatically. You can edit later.</p>
      </div>

      <div class="card">
        <div class="row">
          <h2>Categories</h2>
          <button class="btn ghost right small" onclick="clearAll()">Clear All</button>
        </div>
        <div id="cat-list" style="margin-top:8px;"></div>
        <p id="no-cats" style="color:var(--muted);">No categories yet. Add one above.</p>
      </div>
    </div>
    <nav>
      <button onclick="showPage('dashboard')">üè† Dashboard</button>
      <button class="active" onclick="showPage('budget')">üí∞ Budget</button>
      <button onclick="showPage('accounts')">üè¶ Accounts</button>
      <button disabled>üìà Insights</button>
      <button disabled>üë§ Profile</button>
    </nav>
  </section>

  <!-- ACCOUNTS -->
  <section id="accounts" class="hidden">
    <header><h1>Accounts</h1>
      <button class="btn outline right" onclick="openTxModal()">+ Add Transaction</button>
    </header>
    <div class="container">
      <div class="card">
        <h2>Transactions</h2>
        <div id="tx-list"></div>
        <p id="no-tx" style="color:var(--muted);">No transactions yet. Add one to get started.</p>
      </div>
    </div>
    <nav>
      <button onclick="showPage('dashboard')">üè† Dashboard</button>
      <button onclick="showPage('budget')">üí∞ Budget</button>
      <button class="active" onclick="showPage('accounts')">üè¶ Accounts</button>
      <button disabled>üìà Insights</button>
      <button disabled>üë§ Profile</button>
    </nav>
  </section>

  <!-- EDIT CATEGORY MODAL -->
  <div id="edit-modal" class="backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Edit Category</h3>
      <div class="row">
        <div style="flex:1;min-width:180px;">
          <label for="edit-name">Name</label>
          <select id="edit-name"></select>
        </div>
        <div style="flex:1;min-width:120px;">
          <label for="edit-budget">Budget ($)</label>
          <input id="edit-budget" type="number" min="0" step="1" />
        </div>
        <div style="flex:1;min-width:160px;">
          <label for="edit-color">Color</label>
          <select id="edit-color"></select>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button class="btn ghost" onclick="closeEdit()">Cancel</button>
        <button class="btn primary" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <!-- ADD TRANSACTION MODAL -->
  <div id="tx-modal" class="backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Add Transaction</h3>
      <div class="row">
        <div style="flex:2;min-width:200px;">
          <label for="tx-name">Name</label>
          <input id="tx-name" type="text" placeholder="e.g., Netflix">
        </div>
        <div style="flex:1;min-width:140px;">
          <label for="tx-amount">Amount ($)</label>
          <input id="tx-amount" type="number" min="0" step="1" placeholder="0">
        </div>
        <div style="flex:1;min-width:180px;">
          <label for="tx-date">Date</label>
          <input id="tx-date" type="date">
        </div>
        <div style="flex:1;min-width:180px;">
          <label for="tx-category">Category</label>
          <select id="tx-category"></select>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button class="btn ghost" onclick="closeTxModal()">Cancel</button>
        <button class="btn primary" onclick="saveTx()">Add</button>
      </div>
    </div>
  </div>
<!-- ADD INCOME MODAL -->
<div id="income-modal" class="backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>Add Income Source</h3>
    <div class="row">
      <div style="flex:2;min-width:200px;">
        <label for="income-name">Name</label>
        <input id="income-name" type="text" placeholder="e.g., Main Job, Side Gig">
      </div>
      <div style="flex:1;min-width:140px;">
        <label for="income-amount">Amount ($)</label>
        <input id="income-amount" type="number" min="0" step="1" placeholder="0">
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px;">
      <button class="btn ghost" onclick="closeIncomeModal()">Cancel</button>
      <button class="btn primary" onclick="saveIncome()">Add</button>
    </div>
  </div>
</div>
  <!-- EDIT INCOME MODAL -->
<div id="edit-income-modal" class="backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>Edit or Delete Income Sources</h3>
    <div id="income-list" style="margin-top:10px;"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px;">
      <button class="btn ghost" onclick="closeEditIncomeModal()">Close</button>
    </div>
  </div>
</div>
  <script>
    /************ PRESETS ************/
    const PRESETS = [
      { name: "Food & Dining", color: "#6EE7B7" },
      { name: "Rent / Mortgage", color: "#60A5FA" },
      { name: "Transportation", color: "#FBBF24" },
      { name: "Utilities", color: "#F87171" },
      { name: "Subscriptions", color: "#C084FC" },
      { name: "Health & Fitness", color: "#34D399" },
      { name: "Work / Education", color: "#A78BFA" },
      { name: "Entertainment", color: "#F472B6" },
      { name: "Shopping", color: "#FACC15" },
      { name: "Savings", color: "#4ADE80" },
    ];
    const STORAGE = {
      cats: "saavr_v3_4_categories",
      income: "saavr_v3_4_income",
      login: "saavr_v3_4_login",
      tx: "saavr_v3_4_transactions",
      month: "saavr_v3_4_month"
    };

    /************ STATE ************/
    let categories = []; // {id,name,budget,color}
    let transactions = []; // {id,name,amount,categoryId|null,date:"YYYY-MM-DD"}
    let editingId = null;
    let selectedMonth = ""; // "YYYY-MM"

    /************ HELPERS ************/
    const $ = s => document.querySelector(s);
    const uid = () => Math.random().toString(36).slice(2,9);
    const pad2 = n => String(n).padStart(2,"0");

    function mixMuted(hex, alpha){
      const bg = {r:42,g:50,b:55}; // #2A3237
      const c = parseInt(hex.replace('#',''),16);
      const r=(c>>16)&255, g=(c>>8)&255, b=c&255;
      const rr = Math.round(r*alpha + bg.r*(1-alpha));
      const gg = Math.round(g*alpha + bg.g*(1-alpha));
      const bb = Math.round(b*alpha + bg.b*(1-alpha));
      return `rgb(${rr}, ${gg}, ${bb})`;
    }
    function income(){ return Number(localStorage.getItem(STORAGE.income) || 0); }
    function ymFromDateStr(d){
      if(!d) return "";
      return d.slice(0,7); // YYYY-MM
    }
    function getCurrentYM(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    }
    /************ CUSTOM MONTH PICKER ************/
function changeMonth(offset) {
  // offset: -1 for prev, +1 for next
  const [y, m] = selectedMonth.split("-").map(Number);
  const newDate = new Date(y, m - 1 + offset, 1);
  const newYM = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, "0")}`;

  // limit forward navigation
  if (newYM > getMaxAllowedMonth()) return;

  selectedMonth = newYM;
  localStorage.setItem(STORAGE.month, selectedMonth);

  // update display
  updateMonthDisplay();
  drawDonuts();
  renderDashboardProgress();
  renderBudgetProgress();
  renderCategoryList();
}

function updateMonthDisplay() {
  const md = document.getElementById("month-display");
  if (md) md.textContent = monthLabel(selectedMonth);

  // disable next-month button if future
  const nextBtn = document.getElementById("next-month");
  if (nextBtn) nextBtn.disabled = selectedMonth >= getMaxAllowedMonth();
}
function getMaxAllowedMonth() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth(); // 0-based
  const day = today.getDate();

  // If it's before the 1st (never happens, but safe) or before next month‚Äôs 1st
  // we only allow up to current month
  // Once it's the 1st of next month, the new month becomes available
  const nextMonth = new Date(year, month + 1, 1);
  if (today < nextMonth) {
    return `${year}-${String(month + 1).padStart(2, "0")}`;
  } else {
    const nextYear = month === 11 ? year + 1 : year;
    const nextM = (month + 2) % 12 || 12;
    return `${nextYear}-${String(nextM).padStart(2, "0")}`;
  }
}
    function monthLabel(ym){
      if(!ym) return "";
      const [y,m] = ym.split("-").map(Number);
      const dt = new Date(y, m-1, 1);
      return dt.toLocaleString(undefined, { month: "long", year: "numeric" });
    }
    function formatLongDate(iso){
      if(!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString(undefined,{ month:"short", day:"numeric", year:"numeric"});
    }

    function load(){
      try{ categories = JSON.parse(localStorage.getItem(STORAGE.cats) || "[]"); }catch{ categories=[]; }
      try{ transactions = JSON.parse(localStorage.getItem(STORAGE.tx) || "[]"); }catch{ transactions=[]; }
      selectedMonth = localStorage.getItem(STORAGE.month) || getCurrentYM();
    }
    function save(){
      localStorage.setItem(STORAGE.cats, JSON.stringify(categories));
      localStorage.setItem(STORAGE.tx, JSON.stringify(transactions));
      renderAll();
    }

    /************ FILTERED TOTALS (by month) ************/
    function txForMonth(ym){
      return transactions.filter(t => ymFromDateStr(t.date) === ym);
    }
    function actualByCategory(catId, ym){
      return txForMonth(ym).filter(t=>t.categoryId===catId).reduce((s,t)=>s+(Number(t.amount)||0),0);
    }
    function totalActual(ym){
      return categories.reduce((s,c)=>s+actualByCategory(c.id, ym), 0);
    }
    function totalReceivedIncome(ym) {
  return txForMonth(ym)
    .filter(t => t.categoryId === "income")
    .reduce((s, t) => s + (Number(t.amount) || 0), 0);
}
    function totalBudget(){ return categories.reduce((s,c)=>s+(Number(c.budget)||0),0); }
    function remaining(ym){ return income() - totalActual(ym); }

    /************ LOGIN & NAV ************/
    function initLogin(){
      if (sessionStorage.getItem(STORAGE.login)==="1"){ $("#login").classList.add("hidden"); $("#dashboard").classList.remove("hidden"); }
      $("#login-btn").addEventListener("click",()=>{
        const u=$("#u").value.trim(), p=$("#p").value.trim();
        if(u==="admin" && p==="1234"){ sessionStorage.setItem(STORAGE.login,"1"); showPage("dashboard"); $("#login-err").classList.add("hidden"); }
        else $("#login-err").classList.remove("hidden");
      });
    }
    function showPage(id){
      ["login","dashboard","budget","accounts"].forEach(pid=>{
        const s=document.getElementById(pid);
        if(!s) return;
        if(pid===id) s.classList.remove("hidden"); else s.classList.add("hidden");
      });
      document.querySelectorAll("nav").forEach(nav=>{
        nav.querySelectorAll("button").forEach(btn=>{
          if(btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(id)) btn.classList.add("active"); else btn.classList.remove("active");
        });
      });
      // render current month label on dashboard
      const dm = $("#dash-month");
      if(dm){ dm.textContent = " ‚Äî " + monthLabel(selectedMonth); }
      drawDonuts();
      renderDashboardProgress();
      renderBudgetProgress();
      renderTxList();
    }

    /************ CATEGORY CRUD ************/
    function presetFor(name){ return PRESETS.find(p=>p.name===name) || PRESETS[0]; }
    function showError(el, msg) {
  if (!el) return;
  el.textContent = msg;
  el.classList.remove("hidden");
}

function clearError(el) {
  if (!el) return;
  el.textContent = "";
  el.classList.add("hidden");
}

   function addCategory() {
  const msg = $("#add-error");
  clearError(msg);

  const name = $("#cat-select").value;
  const budget = Number($("#cat-amount").value);
  const inc = Number(localStorage.getItem("saavr_v3_4_income") || 0);

  if (!name || !(budget > 0)) {
    showError(msg, "Choose a category and enter a positive budget.");
    return;
  }

  if (!(inc > 0)) {
    showError(msg, "Please set your monthly income first.");
    return;
  }

  const totalBudget = categories.reduce((s, c) => s + (Number(c.budget) || 0), 0);
  if (totalBudget + budget > inc) {
    showError(msg, `Total budget exceeds your monthly income of $${inc.toLocaleString()}.`);
    return;
  }

  const p = presetFor(name);
  const existing = categories.find(c => c.name === name);
  if (existing) {
    existing.budget = budget;
    existing.color = p.color;
  } else {
    categories.push({ id: uid(), name, budget, color: p.color });
  }

  $("#cat-amount").value = "";
  save();
}
    function clearAll(){
      if(confirm("Remove all categories and transactions?")){
        categories=[]; transactions=[]; save();
      }
    }

    /************ TRANSACTIONS (Accounts) ************/
    function openTxModal(){
      $("#tx-name").value = "";
      $("#tx-amount").value = "";
      const today = new Date();
      $("#tx-date").value = `${today.getFullYear()}-${pad2(today.getMonth()+1)}-${pad2(today.getDate())}`;
      populateTxCategoryDropdown();
      $("#tx-modal").classList.remove("hidden");
    }
    function closeTxModal(){ $("#tx-modal").classList.add("hidden"); }
    function saveTx(){
      const name = $("#tx-name").value.trim();
      const amt = Number($("#tx-amount").value);
      const d = $("#tx-date").value;
      const cat = $("#tx-category").value || "";
      if(!name || !(amt>0) || !d){ alert("Enter a name, positive amount, and date."); return; }
      transactions.push({ id: uid(), name, amount: amt, categoryId: cat || null, date: d });
      closeTxModal();
      save();
    }
    function setTxCategory(txId, catId){
      transactions = transactions.map(t => t.id===txId ? {...t, categoryId: catId || null} : t);
      save();
    }
    function deleteTx(txId){
      transactions = transactions.filter(t => t.id!==txId);
      save();
    }
    function renderTxList(){
      const list = $("#tx-list");
      const empty = $("#no-tx");
      if(!list) return;
      list.innerHTML="";
      if(!transactions.length){ if(empty) empty.classList.remove("hidden"); return; }
      if(empty) empty.classList.add("hidden");
      transactions.forEach(t=>{
        const row = document.createElement("div");
        row.className = "cat-item";
        const cat = categories.find(c=>c.id===t.categoryId);
        const color = cat ? cat.color : "#3c464c";
        const sw = document.createElement("div"); sw.className="swatch"; sw.style.background=color;
        const mid = document.createElement("div");
        const nm = document.createElement("div"); nm.className="cat-name"; nm.textContent=t.name;
        const details = document.createElement("div"); details.style.color="var(--muted)"; details.style.fontSize="12px";
        const catLabel = cat ? `Category: ${cat.name}` : "Uncategorized";
        const dateLabel = t.date ? ` ‚Ä¢ ${formatLongDate(t.date)}` : "";
        details.textContent = catLabel + dateLabel;
        mid.appendChild(nm); mid.appendChild(details);
        const right = document.createElement("div");
        const amt = document.createElement("div"); amt.className="cat-amount"; amt.textContent = `$${(t.amount||0).toLocaleString()}`;
        const actions = document.createElement("div"); actions.className="cat-actions";
        
        // Category dropdown
        const sel = document.createElement("select");
        const optNone = document.createElement("option"); optNone.value=""; optNone.textContent="Uncategorized"; sel.appendChild(optNone);
        categories.forEach(c=>{
          const o=document.createElement("option"); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
        });
        sel.value = t.categoryId || "";
        sel.onchange = e => setTxCategory(t.id, e.target.value || null);

        const del = document.createElement("button"); del.className="btn ghost small"; del.textContent="üóëÔ∏è Delete"; del.onclick=()=>deleteTx(t.id);

        actions.appendChild(sel); actions.appendChild(del);
        right.appendChild(amt); right.appendChild(actions);

        row.appendChild(sw); row.appendChild(mid); row.appendChild(right);
        list.appendChild(row);
      });
    }
    /************ INCOME (Multiple Sources) ************/
let incomes = []; // {id,name,amount}

function openIncomeModal() {
  document.getElementById("income-name").value = "";
  document.getElementById("income-amount").value = "";
  document.getElementById("income-modal").classList.remove("hidden");
}

function closeIncomeModal() {
  document.getElementById("income-modal").classList.add("hidden");
}

function saveIncome() {
  const name = document.getElementById("income-name").value.trim();
  const amt = Number(document.getElementById("income-amount").value);
  if (!name || !(amt > 0)) {
    alert("Enter a name and positive amount.");
    return;
  }
  incomes.push({ id: uid(), name, amount: amt });
  localStorage.setItem("saavr_v3_4_incomes", JSON.stringify(incomes));
  closeIncomeModal();
  renderTotalIncome();
}

function renderTotalIncome() {
  const total = incomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
  document.getElementById("income-total").textContent = `$${total.toLocaleString()}`;
  localStorage.setItem(STORAGE.income, total); // keep dashboard logic compatible
  drawDonuts();
  renderDashboardProgress();
  renderBudgetProgress();
}

function loadIncomes() {
  try {
    incomes = JSON.parse(localStorage.getItem("saavr_v3_4_incomes") || "[]");
  } catch {
    incomes = [];
  }
  renderTotalIncome();
  renderIncomeProgress();
}
function populateTxCategoryDropdown(){
  const sel = $("#tx-category");
  if(!sel) return;
  sel.innerHTML = "";

  // Default Uncategorized option
  const optNone = document.createElement("option");
  optNone.value = "";
  optNone.textContent = "Uncategorized";
  sel.appendChild(optNone);

  // üü¢ Built-in Income option
  const optIncome = document.createElement("option");
  optIncome.value = "income"; // special keyword
  optIncome.textContent = "Income (Deposit)";
  sel.appendChild(optIncome);

  // Add user-created categories
  categories.forEach(c => {
    const o = document.createElement("option");
    o.value = c.id;
    o.textContent = c.name;
    sel.appendChild(o);
  });
}
    function openEditIncomeModal() {
  const modal = document.getElementById("edit-income-modal");
  const list = document.getElementById("income-list");
  list.innerHTML = "";

  if (incomes.length === 0) {
    list.innerHTML = `<p style="color:var(--muted);text-align:center;">No income sources yet.</p>`;
  } else {
    incomes.forEach((inc) => {
      const row = document.createElement("div");
      row.className = "cat-item";

      const mid = document.createElement("div");
      mid.innerHTML = `<div class="cat-name">${inc.name}</div>
                       <div style="color:var(--muted);font-size:12px;">$${Number(inc.amount).toLocaleString()}</div>`;

      const right = document.createElement("div");
      right.className = "cat-actions";

      const editBtn = document.createElement("button");
      editBtn.className = "btn ghost small";
      editBtn.textContent = "‚úèÔ∏è Edit";
      editBtn.onclick = () => editIncomeSource(inc.id);

      const delBtn = document.createElement("button");
      delBtn.className = "btn ghost small";
      delBtn.textContent = "üóëÔ∏è Delete";
      delBtn.onclick = () => deleteIncomeSource(inc.id);

      right.appendChild(editBtn);
      right.appendChild(delBtn);

      row.appendChild(mid);
      row.appendChild(right);
      list.appendChild(row);
    });
  }

  modal.classList.remove("hidden");
}

function closeEditIncomeModal() {
  document.getElementById("edit-income-modal").classList.add("hidden");
}

function editIncomeSource(id) {
  const inc = incomes.find(i => i.id === id);
  if (!inc) return;

  const newName = prompt("Edit income name:", inc.name);
  if (newName === null) return;

  const newAmt = Number(prompt("Edit income amount ($):", inc.amount));
  if (!(newAmt > 0)) return alert("Amount must be positive.");

  inc.name = newName.trim();
  inc.amount = newAmt;

  localStorage.setItem("saavr_v3_4_incomes", JSON.stringify(incomes));
  renderTotalIncome();
  openEditIncomeModal(); // refresh list
}

function deleteIncomeSource(id) {
  if (!confirm("Delete this income source?")) return;

  incomes = incomes.filter(i => i.id !== id);
  localStorage.setItem("saavr_v3_4_incomes", JSON.stringify(incomes));
  renderTotalIncome();
  openEditIncomeModal(); // refresh list
}
    /************ RENDER CATEGORY LIST (Budget) ************/
    function renderCategoryList(){
      const list = $("#cat-list");
      const empty = $("#no-cats");
      if(!list) return;
      list.innerHTML="";
      if(!categories.length){ if(empty) empty.classList.remove("hidden"); return; }
      if(empty) empty.classList.add("hidden");
      categories.forEach(c=>{
        const actual = actualByCategory(c.id, selectedMonth);
        const item = document.createElement("div"); item.className="cat-item"; if (actual > (Number(c.budget) || 0)) {item.classList.add("overspent");}
        const sw = document.createElement("div"); sw.className="swatch"; sw.style.background=c.color;
        const mid = document.createElement("div");
        const nm = document.createElement("div"); nm.className="cat-name"; nm.textContent=c.name;
        const details = document.createElement("div"); details.style.color="var(--muted)"; details.style.fontSize="12px";
        details.textContent = `Budget: $${(c.budget||0).toLocaleString()} ¬∑ Actual (${monthLabel(selectedMonth)}): $${(actual||0).toLocaleString()}`;
        mid.appendChild(nm); mid.appendChild(details);
        const right = document.createElement("div");
        const amt = document.createElement("div"); amt.className="cat-amount"; amt.textContent = `$${(c.budget||0).toLocaleString()}`;
        const actions = document.createElement("div"); actions.className="cat-actions";
        const b1 = document.createElement("button"); b1.className="btn ghost small"; b1.textContent="‚úèÔ∏è Edit"; b1.onclick=()=>openEdit(c.id);
        const b2 = document.createElement("button"); b2.className="btn ghost small"; b2.textContent="üóëÔ∏è Delete"; b2.onclick=()=>delCategory(c.id);
        actions.appendChild(b1); actions.appendChild(b2);
        right.appendChild(amt); right.appendChild(actions);

        item.appendChild(sw); item.appendChild(mid); item.appendChild(right);
        list.appendChild(item);
      });
    }

    /************ EDIT CATEGORY MODAL ************/
    function openEdit(id){
      editingId = id;
      const c = categories.find(x=>x.id===id); if(!c) return;
      const nameSel = $("#edit-name"); nameSel.innerHTML="";
      PRESETS.forEach(p=>{ const o=document.createElement("option"); o.value=p.name; o.textContent=p.name; nameSel.appendChild(o); });
      nameSel.value = c.name;
      $("#edit-budget").value = c.budget;
      const colorSel = $("#edit-color"); colorSel.innerHTML="";
      PRESETS.forEach(p=>{ const o=document.createElement("option"); o.value=p.color; o.textContent=`${p.name} (${p.color})`; colorSel.appendChild(o); });
      colorSel.value = c.color;
      $("#edit-modal").classList.remove("hidden");
    }
    function closeEdit(){ $("#edit-modal").classList.add("hidden"); editingId=null; }
    function saveEdit(){
      const c = categories.find(x=>x.id===editingId); if(!c) return;
      const newName = $("#edit-name").value;
      const newBudget = Number($("#edit-budget").value);
      const newColor = $("#edit-color").value;
      if(!(newBudget>0)){ alert("Budget must be positive."); return; }
      c.name = newName; c.budget = newBudget; c.color = newColor;
      closeEdit(); save();
    }
    function delCategory(id){
      if(!confirm("Delete this category and uncategorize related transactions?")) return;
      categories = categories.filter(c=>c.id!==id);
      transactions = transactions.map(t => t.categoryId===id ? {...t, categoryId:null} : t);
      save();
    }

    /************ DONUT DRAWING (Single-ring) ************/
    function polarToXY(cx, cy, r, angle){
      const a = (angle-90) * Math.PI/180;
      return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
    }
    function arcPath(cx, cy, r, start, end){
      const p1 = polarToXY(cx, cy, r, end);
      const p2 = polarToXY(cx, cy, r, start);
      const large = end-start <= 180 ? 0 : 1;
      return `M ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} 0 ${p2.x} ${p2.y}`;
    }
    function drawDonutForMonth(svgId, centerId, ym){
  const svg = document.getElementById(svgId);
  const centerEl = document.getElementById(centerId);
  while(svg.firstChild) svg.removeChild(svg.firstChild);

  const cx = 130, cy = 130, r = 100, stroke = 30;
  let inc = income();
  const safeInc = inc > 0 ? inc : 1; // use for drawing math
  const spent = totalActual(ym);
  const rem = inc - spent;

  centerEl.textContent = `$${Math.round(rem).toLocaleString()}`;
  centerEl.classList.toggle("center-positive", rem >= 0);
  centerEl.classList.toggle("center-negative", rem < 0);

  // Background ring
  const bg = document.createElementNS("http://www.w3.org/2000/svg","circle");
  bg.setAttribute("cx", cx);
  bg.setAttribute("cy", cy);
  bg.setAttribute("r", r);
  bg.setAttribute("fill", "none");
  bg.setAttribute("stroke", "var(--ringbg)");
  bg.setAttribute("stroke-width", String(stroke));
  svg.appendChild(bg);

  let angle = 0;
  const arcMeta = [];

  // Draw each category slice proportional to total income
  categories.forEach(c => {
    const share = (Number(c.budget) || 0) / safeInc;
    if (share <= 0) return;
    const start = angle * 360;
    const end = (angle + share) * 360;
    arcMeta.push({ id: c.id, start, end, color: c.color, name: c.name, budget: c.budget });
    angle += share;

    // Base muted arc
    const base = document.createElementNS("http://www.w3.org/2000/svg","path");
    base.setAttribute("d", arcPath(cx, cy, r, start, end));
    base.setAttribute("stroke", mixMuted(c.color, 0.4));
    base.setAttribute("stroke-width", String(stroke));
    base.setAttribute("fill", "none");
    base.style.cursor = "pointer";
    base.addEventListener("mousemove", e => showSliceTooltip(e, c, inc, ym));
    base.addEventListener("mouseleave", hideTooltip);
    svg.appendChild(base);
  });

  // Add remaining-income slice (if not fully allocated)
  if (angle < 1) {
    const start = angle * 360;
    const end = 360;
    const remPath = document.createElementNS("http://www.w3.org/2000/svg","path");
    remPath.setAttribute("d", arcPath(cx, cy, r, start, end));
    remPath.setAttribute("stroke", "#2F3940"); // light gray for unallocated
    remPath.setAttribute("stroke-width", String(stroke));
    remPath.setAttribute("fill", "none");
    svg.appendChild(remPath);
  }

  // Overlay actuals for selected month
  arcMeta.forEach(meta => {
    const catBudget = Number(meta.budget) || 0;
    const catActual = Math.min(actualByCategory(meta.id, ym), catBudget);
    const frac = catBudget ? (catActual / catBudget) : 0;
    if (frac <= 0) return;

    const bright = document.createElementNS("http://www.w3.org/2000/svg","path");
    const brightEnd = meta.start + (meta.end - meta.start) * frac;
    bright.setAttribute("d", arcPath(cx, cy, r, meta.start, brightEnd));
    bright.setAttribute("stroke", meta.color);
    bright.setAttribute("stroke-width", String(stroke));
    bright.setAttribute("fill", "none");
    bright.style.cursor = "pointer";
    const cat = categories.find(c => c.id === meta.id);
    bright.addEventListener("mousemove", e => showSliceTooltip(e, cat, inc, ym));
    bright.addEventListener("mouseleave", hideTooltip);
    svg.appendChild(bright);
  });
}
    function drawDonuts(){
  // Dashboard always uses current month
  const currentYM = getCurrentYM();
  drawDonutForMonth("dash-donut", "dash-center", currentYM);
  const dm = $("#dash-month");
  if (dm) dm.textContent = " ‚Äî " + monthLabel(currentYM);

  // Budget uses whatever month user selected
  drawDonutForMonth("budget-donut", "budget-center", selectedMonth);
}
    /************ PROGRESS BARS (month-filtered) ************/
    function renderDashboardProgress(){
  const inc = income();
  const spent = totalActual(selectedMonth);
  const pct = inc > 0 ? Math.min(100, Math.round((spent / inc) * 100)) : 0;
  const bar = document.getElementById("dash-progress");
  const lbl = document.getElementById("dash-progress-label");

  if (bar) {
    bar.style.width = pct + "%";
    // üî¥ turn red when overspent
    if (spent > inc) {
      bar.classList.add("danger");
    } else {
      bar.classList.remove("danger");
    }
  }
  if (lbl) {
    lbl.textContent = `$${spent.toLocaleString()} / $${inc.toLocaleString()} spent`;
  }
}

function renderBudgetProgress(){
  const inc = income();
  const spent = totalActual(selectedMonth);
  const pct = inc > 0 ? Math.min(100, Math.round((spent / inc) * 100)) : 0;
  const bar = document.getElementById("budget-progress");
  const lbl = document.getElementById("budget-progress-label");

  if (bar) {
    bar.style.width = pct + "%";
    // üî¥ turn red when overspent
    if (spent > inc) {
      bar.classList.add("danger");
    } else {
      bar.classList.remove("danger");
    }
  }
  if (lbl) {
    lbl.textContent = `$${spent.toLocaleString()} / $${inc.toLocaleString()} spent`;
  }
}
function renderIncomeProgress() {
  const target = income(); // planned income total
  const received = totalReceivedIncome(selectedMonth); // actual deposits

  const bar = document.getElementById("income-progress");
  const lbl = document.getElementById("income-progress-label");

  // üü¢ Handle case when no total income is set
  if (target <= 0) {
    if (bar) {
      bar.style.width = "0%";
      bar.style.background = "var(--mint)";
      bar.style.opacity = "0.35"; // subtle dim until income set
    }
    if (lbl) lbl.textContent = `Set your monthly income to track progress`;
    return;
  }

  const pct = Math.min(100, Math.round((received / target) * 100));

  if (bar) {
    bar.style.width = pct + "%";
    bar.style.background = "var(--mint)"; // ‚úÖ always mint green
    bar.style.opacity = "1";
  }

  if (lbl) {
    lbl.textContent = `${pct}% of income received ($${received.toLocaleString()} / $${target.toLocaleString()})`;
  }
}
/************ TOOLTIP (Hover Info) ************/
function showSliceTooltip(evt, cat, inc, ym) {
  const tip = document.getElementById("tooltip");
  const actual = actualByCategory(cat.id, ym);
  const budget = Number(cat.budget) || 0;
  const diff = actual - budget;

  const spentLine = `<div class="row"><span style="color:var(--muted)">Spent</span><b>$${actual.toLocaleString()}</b></div>`;
  const budgetLine = `<div class="row"><span style="color:var(--muted)">Budget</span><b>$${budget.toLocaleString()}</b></div>`;

  let diffLine = "";
  if (diff > 0) {
    diffLine = `<div class="row"><span style="color:var(--muted)">Over by</span><b style="color:var(--danger)">+$${diff.toLocaleString()}</b></div>`;
  } else {
    const left = Math.abs(diff);
    diffLine = `<div class="row"><span style="color:var(--muted)">Left</span><b style="color:var(--mint)">$${left.toLocaleString()}</b></div>`;
  }

  tip.innerHTML = `
    <div class="title">${cat.name}</div>
    ${spentLine}
    ${budgetLine}
    ${diffLine}
  `;

  // follow cursor
  tip.style.left = evt.clientX + 14 + "px";
  tip.style.top = evt.clientY + 14 + "px";
  tip.classList.add("visible");
}

function hideTooltip() {
  const tip = document.getElementById("tooltip");
  if (tip) tip.classList.remove("visible");
}

    /************ RENDER ALL ************/
    function renderAll(){
      // category dropdowns
      const addSel = document.getElementById("cat-select"); if(addSel){ addSel.innerHTML=""; PRESETS.forEach(p=>{ const o=document.createElement("option"); o.value=p.name; o.textContent=p.name; addSel.appendChild(o); }); }
      // list & tx
      renderCategoryList();
      renderTxList();
      populateTxCategoryDropdown();
      // donuts + progress + labels
      drawDonuts();
      renderDashboardProgress();
      renderBudgetProgress();
      renderIncomeProgress();
    }

    /************ INIT ************/
window.addEventListener("DOMContentLoaded", () => {
  load();
  initLogin();

  // Income save
document.getElementById("add-income-btn").addEventListener("click", openIncomeModal);
loadIncomes();
  // Add category
  document.getElementById("add-cat").addEventListener("click", addCategory);

  // üü¢ Remove the old month-picker (<input type="month">) block entirely

  // üü¢ Add this instead:
  const prev = document.getElementById("prev-month");
  const next = document.getElementById("next-month");
  if (prev && next) {
    prev.addEventListener("click", () => changeMonth(-1));
    next.addEventListener("click", () => changeMonth(1));
  }
  updateMonthDisplay();

  // Start page
  if (sessionStorage.getItem(STORAGE.login) === "1")
    showPage("dashboard");
  else
    showPage("login");

  renderAll();
});
  </script>
</body>
</html>


























