<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Buddy v2 — Income & Expenses</title>
<style>
  :root{
    --bg:#0f1115;
    --card:#161a22;
    --muted:#8fa1b3;
    --text:#e7edf3;
    --accent:#6FE3B5; /* mint */
    --danger:#ff6b6b;
    --border:#252b36;
    --ring: #273142;
    --good:#2ecc71;
    --bad:#ff7675;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    background: radial-gradient(1000px 600px at 80% -10%, #1b2230 0%, var(--bg) 60%);
    color:var(--text);
    line-height:1.35;
  }
  header{
    padding:24px 20px 8px;
    display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;
  }
  h1{font-size:20px; margin:0; letter-spacing:0.2px}
  .badge{background:rgba(111,227,181,.12); border:1px solid rgba(111,227,181,.25); color:var(--accent); padding:3px 8px; border-radius:999px; font-size:12px}
  .wrap{max-width:1200px; margin:0 auto; padding:0 20px 40px}
  .grid{display:grid; grid-template-columns: 1.1fr 1.1fr 420px; gap:18px}
  @media (max-width: 1200px){ .grid{grid-template-columns: 1fr 1fr} }
  @media (max-width: 920px){ .grid{grid-template-columns: 1fr} }
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25); backdrop-filter: blur(6px)}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap}
  button, .btn{
    border:1px solid var(--border); background:#1b2130; color:var(--text); padding:10px 12px;
    border-radius:10px; cursor:pointer; font-weight:600; font-size:14px
  }
  button:hover{box-shadow:0 0 0 3px var(--ring)}
  .btn-accent{ background: linear-gradient(180deg, rgba(111,227,181,.25), rgba(111,227,181,.1)); border:1px solid rgba(111,227,181,.45)}
  .btn-danger{ background: linear-gradient(180deg, rgba(255,107,107,.15), rgba(255,107,107,.05)); border:1px solid rgba(255,107,107,.35)}
  .btn-ghost{ background: transparent }
  .inputs{display:grid; grid-template-columns: 1.2fr 0.6fr 0.5fr auto; gap:10px; padding:14px; border-bottom:1px dashed var(--border)}
  @media (max-width:600px){ .inputs{grid-template-columns: 1fr 1fr} .hide-sm{display:none} }
  .inputs input[type="text"], .inputs input[type="number"]{
    width:100%; padding:10px 11px; border-radius:10px; border:1px solid var(--border); background:#0f1420; color:var(--text);
  }
  .inputs input[type="color"]{ width:100%; height:40px; border:1px solid var(--border); background:transparent; border-radius:10px; padding:0}
  h2{font-size:16px; margin:0; padding:12px 14px; border-bottom:1px dashed var(--border)}
  .section{display:flex; flex-direction:column}
  table{width:100%; border-collapse:separate; border-spacing:0 8px; padding:10px}
  thead th{font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); text-align:left; padding:0 10px}
  tbody tr{ background: #131824; border:1px solid var(--border); }
  tbody tr td{ padding:12px 10px; vertical-align:middle }
  tbody tr td:first-child{ border-radius:10px 0 0 10px }
  tbody tr td:last-child{ border-radius:0 10px 10px 0 }
  .swatch{ width:18px; height:18px; border-radius:6px; display:inline-block; border:1px solid #0002; box-shadow:0 1px 2px #0005; vertical-align:middle; margin-right:8px}
  .amount{ font-variant-numeric: tabular-nums; text-align:right; }
  .editable{ border:1px dashed transparent; border-radius:6px; padding:4px 6px; min-width:40px; display:inline-block}
  .editable:focus{ outline:none; border-color: var(--ring); background:#0d1120 }
  .row-actions{ display:flex; gap:8px; justify-content:flex-end }
  .totalbar{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-top:1px dashed var(--border); color:var(--muted)}
  .totalbar strong{ font-size:18px; color:var(--text) }
  .muted{ color:var(--muted) }
  .pie-card{ padding:16px; display:flex; flex-direction:column; gap:12px }
  canvas{ width:100%; height:auto; aspect-ratio:1 / 1; }
  .legend{ display:grid; grid-template-columns: 1fr; gap:8px; max-height:260px; overflow:auto; padding-right:6px }
  .legend .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#121724 }
  .legend .left{ display:flex; align-items:center; gap:10px }
  .empty{ padding:18px; text-align:center; color:var(--muted) }
  .pill{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:transparent}
  .ok{ color:#aaf0c4; border-color:#2a5d4b }
  .warn{ color:#ffd3d3; border-color:#5d2a2a }
  .netline{ display:flex; align-items:center; gap:10px; padding:6px 0}
  .toggle{ display:flex; gap:8px; }
  .toggle button[aria-pressed="true"]{ outline:2px solid var(--accent) }
</style>
</head>
<body>
  <header class="wrap">
    <div style="display:flex; align-items:center; gap:10px;">
      <h1>Budget Buddy v2</h1>
      <span class="badge">Income • Expenses • Donut</span>
    </div>
    <div class="toolbar">
      <div class="group">
        <button id="exportBtn" class="btn">Export CSV</button>
        <button id="importBtn" class="btn btn-ghost">Import CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none" />
      </div>
      <div class="group">
        <button id="resetBtn" class="btn btn-danger">Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Income Section -->
    <section class="card section" id="incomeSection">
      <h2>Income</h2>
      <div class="inputs">
        <input id="incName" type="text" placeholder="Income category (e.g., Paycheck, Side Hustle)" />
        <input id="incAmt" type="number" placeholder="Amount" step="0.01" min="0" />
        <input id="incColor" type="color" value="#59d98b" class="hide-sm" />
        <button id="addIncome" class="btn btn-accent">Add Income</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th class="hide-sm">Color</th>
              <th style="text-align:right">Amount</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="incomeBody"></tbody>
        </table>
      </div>
      <div class="totalbar">
        <span class="muted">Tip: Click a name or amount to edit. Press Enter to save.</span>
        <div>Income Total: <strong id="incomeTotal">$0.00</strong></div>
      </div>
    </section>

    <!-- Expenses Section -->
    <section class="card section" id="expenseSection">
      <h2>Expenses</h2>
      <div class="inputs">
        <input id="expName" type="text" placeholder="Expense category (e.g., Rent, Groceries)" />
        <input id="expAmt" type="number" placeholder="Amount" step="0.01" min="0" />
        <input id="expColor" type="color" value="#ff9f7f" class="hide-sm" />
        <button id="addExpense" class="btn btn-accent">Add Expense</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th class="hide-sm">Color</th>
              <th style="text-align:right">Amount</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="expenseBody"></tbody>
        </table>
      </div>
      <div class="totalbar">
        <span class="muted">CSV supports Type,Category,Amount,Color.</span>
        <div>Expense Total: <strong id="expenseTotal">$0.00</strong></div>
      </div>
    </section>

    <!-- Chart / Summary -->
    <aside class="card pie-card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <div>
          <h2 style="margin:0; font-size:16px">Total View</h2>
          <div class="netline">
            <span class="pill ok">Income: <span id="sumIncome">$0.00</span></span>
            <span class="pill warn">Expenses: <span id="sumExpense">$0.00</span></span>
          </div>
          <div class="netline">
            Net: <strong id="net">$0.00</strong>
          </div>
        </div>
        <div class="toggle" role="tablist" aria-label="Chart mode">
          <button id="showExpenses" class="btn" aria-pressed="true">Expenses Donut</button>
          <button id="showIncome" class="btn btn-ghost" aria-pressed="false">Income Donut</button>
        </div>
      </div>
      <canvas id="pie" width="640" height="640" aria-label="Budget Donut Chart"></canvas>
      <div id="legend" class="legend"></div>
      <div class="empty" id="emptyState">Add items to see your chart ✨</div>
    </aside>
  </main>

<script>
/* ---------- Utilities ---------- */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const money = (n) => (isNaN(n) ? "$0.00" : n.toLocaleString(undefined, {style:'currency', currency:'USD'}));

function huePastel(rangeMin=0, rangeMax=360){
  const hue = Math.floor(rangeMin + Math.random()*(rangeMax-rangeMin));
  const sat = 65 + Math.random()*18;
  const light = 55 + Math.random()*12;
  const a = sat * Math.min(light/100, 1 - light/100);
  const f = n => {
    const k = (n + hue/30) % 12;
    const color = light/100 - a * Math.max(Math.min(k-3, 9-k, 1), -1);
    return Math.round(255 * color).toString(16).padStart(2, '0');
  };
  return `#${f(0)}${f(8)}${f(4)}`;
}

function uid(){ return Math.random().toString(36).slice(2,9); }

/* ---------- State ---------- */
const LS_KEY = "budget-buddy-v2";
let state = {
  items: [], // {id,type:'income'|'expense', name, amount, color}
  chartMode: 'expense'
};

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){ state = JSON.parse(raw); }
  }catch(e){ console.warn("Failed to load state", e); }
}

/* ---------- DOM Rendering ---------- */
function makeRow(item){
  const tr = document.createElement('tr');
  tr.dataset.id = item.id;

  // Category (editable)
  const tdName = document.createElement('td');
  const nameSpan = document.createElement('span');
  nameSpan.className = 'editable';
  nameSpan.contentEditable = true;
  nameSpan.textContent = item.name;
  nameSpan.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); nameSpan.blur(); }
  });
  nameSpan.addEventListener('blur', ()=>{
    const it = state.items.find(x=>x.id===item.id);
    if(it){ it.name = nameSpan.textContent.trim() || "Untitled"; render(); save(); }
  });
  tdName.appendChild(nameSpan);
  tr.appendChild(tdName);

  // Color
  const tdColor = document.createElement('td');
  tdColor.className = 'hide-sm';
  const sw = document.createElement('span');
  sw.className = 'swatch';
  sw.style.background = item.color;
  const inputColor = document.createElement('input');
  inputColor.type = 'color';
  inputColor.value = item.color;
  inputColor.style.marginLeft = '6px';
  inputColor.addEventListener('input', ()=>{
    const it = state.items.find(x=>x.id===item.id);
    if(it){ it.color = inputColor.value; sw.style.background = it.color; renderPie(); save(); }
  });
  tdColor.appendChild(sw);
  tdColor.appendChild(inputColor);
  tr.appendChild(tdColor);

  // Amount (editable)
  const tdAmt = document.createElement('td');
  tdAmt.className = 'amount';
  const amtSpan = document.createElement('span');
  amtSpan.className = 'editable';
  amtSpan.contentEditable = true;
  amtSpan.textContent = (item.amount||0).toFixed(2);
  amtSpan.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); amtSpan.blur(); }
  });
  amtSpan.addEventListener('blur', ()=>{
    const it = state.items.find(x=>x.id===item.id);
    if(it){
      const val = parseFloat(amtSpan.textContent.replace(/[^\d.\-]/g,''));
      it.amount = isNaN(val) ? 0 : Math.max(0, val);
      amtSpan.textContent = it.amount.toFixed(2);
      renderTotals(); renderPie(); save();
    }
  });
  tdAmt.appendChild(amtSpan);
  tr.appendChild(tdAmt);

  // Actions
  const tdAct = document.createElement('td');
  tdAct.className = 'row-actions';
  const del = document.createElement('button');
  del.textContent = 'Delete';
  del.className = 'btn btn-danger';
  del.addEventListener('click', ()=>{
    state.items = state.items.filter(x=>x.id!==item.id);
    render();
    save();
  });
  tdAct.appendChild(del);
  tr.appendChild(tdAct);

  return tr;
}

function renderTable(){
  const incBody = $('#incomeBody');
  const expBody = $('#expenseBody');
  incBody.innerHTML = ''; expBody.innerHTML = '';

  const incomes = state.items.filter(i=>i.type==='income');
  const expenses = state.items.filter(i=>i.type==='expense');

  if(incomes.length===0){
    const tr = document.createElement('tr');
    const td = document.createElement('td'); td.colSpan=4; td.innerHTML = '<div class="empty">No income yet — add above.</div>';
    tr.appendChild(td); incBody.appendChild(tr);
  }else{
    incomes.forEach(item=> incBody.appendChild(makeRow(item)));
  }

  if(expenses.length===0){
    const tr = document.createElement('tr');
    const td = document.createElement('td'); td.colSpan=4; td.innerHTML = '<div class="empty">No expenses yet — add above.</div>';
    tr.appendChild(td); expBody.appendChild(tr);
  }else{
    expenses.forEach(item=> expBody.appendChild(makeRow(item)));
  }
}

function sumBy(type){
  return state.items.filter(i=>i.type===type).reduce((a,b)=>a+(b.amount||0),0);
}

function renderTotals(){
  const inc = sumBy('income');
  const exp = sumBy('expense');
  $('#incomeTotal').textContent = money(inc);
  $('#expenseTotal').textContent = money(exp);
  $('#sumIncome').textContent = money(inc);
  $('#sumExpense').textContent = money(exp);
  const net = inc - exp;
  $('#net').textContent = money(net);
}

/* ---------- Pie / Donut Chart (vanilla canvas) ---------- */
let pieCanvas;

function drawDonut(segments){
  const c = pieCanvas;
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2;
  const outer = Math.min(W,H)/2 - 20;
  const inner = outer * 0.58;

  const total = segments.reduce((a,b)=>a + b.value, 0);
  if(total <= 0){
    ctx.beginPath();
    ctx.arc(cx,cy,outer,0,Math.PI*2);
    ctx.lineWidth = outer - inner;
    ctx.strokeStyle = '#1f2635';
    ctx.stroke();
    return;
  }

  let start = -Math.PI/2;
  for(const seg of segments){
    const angle = (seg.value/total) * Math.PI*2;
    const end = start + angle;
    ctx.beginPath();
    ctx.arc(cx, cy, outer, start, end);
    ctx.arc(cx, cy, inner, end, start, true);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();
    start = end;
  }

  ctx.fillStyle = '#c8d3e0';
  ctx.font = '600 22px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  const label = total === 0 ? '$0.00' : money(total);
  ctx.fillText(label, cx, cy);
}

function renderLegend(segments){
  const el = $('#legend');
  const empty = $('#emptyState');
  el.innerHTML = '';
  if(segments.length === 0 || segments.reduce((a,b)=>a+b.value,0)===0){
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  segments.forEach(seg=>{
    const row = document.createElement('div');
    row.className = 'item';
    const left = document.createElement('div');
    left.className = 'left';
    const sw = document.createElement('span');
    sw.className = 'swatch'; sw.style.background = seg.color;
    const name = document.createElement('span');
    name.textContent = seg.name;
    left.appendChild(sw); left.appendChild(name);

    const right = document.createElement('div');
    right.style.fontVariantNumeric = 'tabular-nums';
    right.textContent = money(seg.value);

    row.appendChild(left);
    row.appendChild(right);
    el.appendChild(row);
  });
}

function renderPie(){
  const mode = state.chartMode; // 'expense' or 'income'
  const segments = state.items
    .filter(i=>i.type===mode && i.amount>0)
    .map(i=>({name:i.name, value:i.amount, color:i.color}));
  drawDonut(segments);
  renderLegend(segments);
}

/* ---------- CSV Import/Export ---------- */
function toCSV(items){
  const header = 'Type,Category,Amount,Color';
  const lines = items.map(i=>[
    i.type,
    '"' + (i.name||'').replace(/"/g,'""') + '"',
    (i.amount||0),
    i.color || ''
  ].join(','));
  return [header, ...lines].join('\n');
}

function fromCSV(text){
  const rows = text.split(/\r?\n/).filter(Boolean);
  const [hdr, ...data] = rows;
  const items = [];
  for(const line of data){
    // Parse first token (Type), then quoted name, amount, color
    // Support both quoted and unquoted category
    let rest = line;
    // Type
    const c1 = rest.indexOf(',');
    if(c1===-1) continue;
    const typ = rest.slice(0,c1).trim().toLowerCase();
    const type = (typ==='income' || typ==='expense') ? typ : 'expense';
    rest = rest.slice(c1+1);

    let name, amtStr, color;
    if(rest.startsWith('"')){
      const endq = rest.indexOf('",');
      name = rest.slice(1, endq).replaceAll('""','"');
      const rest2 = rest.slice(endq+2);
      const p = rest2.split(',');
      amtStr = p[0]; color = p[1]||'';
    }else{
      const firstComma = rest.indexOf(',');
      name = rest.slice(0, firstComma);
      const rest2 = rest.slice(firstComma+1);
      const p = rest2.split(',');
      amtStr = p[0]; color = p[1]||'';
    }
    const amt = parseFloat(amtStr);
    items.push({id: uid(), type, name: name||'Untitled', amount: isNaN(amt)?0:amt, color: color || (type==='income'? huePastel(90,170) : huePastel(0,30))});
  }
  return items;
}

/* ---------- Event wiring ---------- */
function render(){
  renderTable();
  renderTotals();
  renderPie();
}

function addItem(type, name, amount, color){
  state.items.push({ id: uid(), type, name: name || 'Untitled', amount: amount||0, color: color});
  render(); save();
}

function bindEvents(){
  // Income add
  $('#addIncome').addEventListener('click', ()=>{
    const name = $('#incName').value.trim() || 'Untitled';
    const amount = parseFloat($('#incAmt').value);
    const color = $('#incColor').value || huePastel(90,170);
    addItem('income', name, isNaN(amount)?0:Math.max(0,amount), color);
    $('#incName').value=''; $('#incAmt').value=''; $('#incName').focus();
  });
  $('#incName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addIncome').click(); } });
  $('#incAmt').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addIncome').click(); } });

  // Expense add
  $('#addExpense').addEventListener('click', ()=>{
    const name = $('#expName').value.trim() || 'Untitled';
    const amount = parseFloat($('#expAmt').value);
    const color = $('#expColor').value || huePastel(0,30);
    addItem('expense', name, isNaN(amount)?0:Math.max(0,amount), color);
    $('#expName').value=''; $('#expAmt').value=''; $('#expName').focus();
  });
  $('#expName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addExpense').click(); } });
  $('#expAmt').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addExpense').click(); } });

  // Reset
  $('#resetBtn').addEventListener('click', ()=>{
    if(confirm('Clear all items? This cannot be undone.')){
      state.items = []; render(); save();
    }
  });

  // Export / Import
  $('#exportBtn').addEventListener('click', ()=>{
    const csv = toCSV(state.items);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'budget.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  $('#importBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const items = fromCSV(reader.result);
        state.items = items; render(); save();
      }catch(err){
        alert('Could not import CSV. Expected columns: Type,Category,Amount,Color');
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  });

  // Chart mode toggle
  $('#showExpenses').addEventListener('click', ()=>{
    state.chartMode = 'expense';
    $('#showExpenses').setAttribute('aria-pressed','true');
    $('#showIncome').setAttribute('aria-pressed','false');
    renderPie(); save();
  });
  $('#showIncome').addEventListener('click', ()=>{
    state.chartMode = 'income';
    $('#showExpenses').setAttribute('aria-pressed','false');
    $('#showIncome').setAttribute('aria-pressed','true');
    renderPie(); save();
  });
}

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  pieCanvas = $('#pie');
  load();
  // Seed if empty
  if(!state.items || state.items.length===0){
    state.items = [
      {id:uid(), type:'income', name:'Paycheck', amount:3500, color:'#59d98b'},
      {id:uid(), type:'income', name:'Side Hustle', amount:400, color:'#6FE3B5'},
      {id:uid(), type:'expense', name:'Rent', amount:1200, color:'#ff9f7f'},
      {id:uid(), type:'expense', name:'Groceries', amount:450, color:'#f6d365'},
      {id:uid(), type:'expense', name:'Utilities', amount:220, color:'#b197fc'}
    ];
  }
  render();
  bindEvents();
});
</script>
</body>
</html>
