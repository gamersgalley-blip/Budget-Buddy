<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Buddy v4 — Saavr Hierarchy</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#50C3A3">

<style>
  :root{
    --mint:#50C3A3;
    --dark:#1E2428;
    --card:#22292E;
    --ink:#EAF0F2;
    --ink-dim:#A8B4BC;
    --ink-strong:#F8F8F6;
    --warn:#FF6B6B;
    --ring:#2B343A;
    --grid:#30383E;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
    background: radial-gradient(1100px 700px at 90% -10%, #2a3237 0%, var(--dark) 60%);
    color: var(--ink);
    line-height:1.35;
  }
  header{ padding:22px 20px 10px; }
  .wrap{ max-width:1200px; margin:0 auto; padding:0 20px 40px }
  .top{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px }
  h1{ margin:0; font-size:20px; color:var(--ink-strong) }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap }
  button{
    border:1px solid var(--ring); background:#263036; color:var(--ink);
    padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer
  }
  button:hover{ box-shadow:0 0 0 3px rgba(80,195,163,.18) }
  .btn-mint{ background:linear-gradient(180deg, rgba(80,195,163,.35), rgba(80,195,163,.12)); border-color:#57cfaf }
  .btn-warn{ background:linear-gradient(180deg, rgba(255,107,107,.20), rgba(255,107,107,.06)); border-color:#ff8a8a }

  .grid{ display:grid; grid-template-columns: 1.1fr 1.1fr 430px; gap:18px }
  @media (max-width:1200px){ .grid{ grid-template-columns: 1fr 1fr } }
  @media (max-width:900px){ .grid{ grid-template-columns: 1fr } }

  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); border:1px solid var(--ring); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.28) }
  h2{ margin:0; font-size:16px; padding:12px 14px; border-bottom:1px dashed var(--grid); color:var(--ink-strong) }

  .inputs{ display:grid; grid-template-columns: 1.2fr 0.6fr 0.6fr auto; gap:10px; padding:14px; border-bottom:1px dashed var(--grid) }
  .inputs input{ width:100%; padding:10px 11px; border-radius:10px; border:1px solid var(--ring); background:#141A1E; color:var(--ink) }
  .inputs input[type="color"]{ height:40px; padding:0 }

  table{ width:100%; border-collapse:separate; border-spacing:0 8px; padding:10px }
  thead th{ font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--ink-dim); text-align:left; padding:0 10px }
  tbody tr{ background:#141A1E; border:1px solid var(--ring) }
  tbody td{ padding:10px; vertical-align:middle }
  tbody tr td:first-child{ border-radius:10px 0 0 10px }
  tbody tr td:last-child{ border-radius:0 10px 10px 0 }
  .amount{ text-align:right; font-variant-numeric: tabular-nums }
  .row-actions{ display:flex; gap:8px; justify-content:flex-end }

  .editable{ border:1px dashed transparent; border-radius:6px; padding:4px 6px; min-width:40px; display:inline-block }
  .editable:focus{ outline:none; border-color:#3b7; background:#0f1519 }

  .parent-row{ border-left:3px solid var(--mint) }
  .sub-row td{ padding-left:26px; font-size:14px; color:#ccd6db }

  .colorpick{ width:42px; height:28px; border-radius:8px; border:1px solid var(--ring); background:#0f1519 }

  .totalbar{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-top:1px dashed var(--grid); color:var(--ink-dim) }
  .totalbar strong{ font-size:18px; color:var(--ink-strong) }

  .pie-card{ padding:16px; display:flex; flex-direction:column; gap:12px }
  canvas{ width:100%; height:auto; aspect-ratio:1/1; touch-action:manipulation }
  .muted{ color:var(--ink-dim) }
  .center-msg{ text-align:center; margin-top:-10px; min-height:24px }
  .back-btn{ align-self:flex-end }
</style>
</head>
<body>
<header class="wrap">
  <div class="top">
    <h1>Budget Buddy — Saavr Hierarchy</h1>
    <div class="toolbar">
      <button id="exportBtn" class="btn-mint">Export JSON</button>
      <button id="importBtn">Import JSON</button>
      <input type="file" id="fileInput" accept=".json,application/json" style="display:none" />
      <button id="resetBtn" class="btn-warn">Reset</button>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- Income -->
  <section class="card">
    <h2>Income</h2>
    <div class="inputs">
      <input id="incName" type="text" placeholder="Income (e.g., Paycheck)">
      <input id="incAmt" type="number" placeholder="Amount" step="0.01" min="0">
      <input id="incColor" type="color" value="#50C3A3">
      <button id="addIncome" class="btn-mint">Add Income</button>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Name</th><th>Color</th><th style="text-align:right">Amount</th><th style="text-align:right">Actions</th></tr></thead>
        <tbody id="incomeBody"></tbody>
      </table>
    </div>
    <div class="totalbar">
      <span class="muted">Tap names/amounts to edit. Auto-saves.</span>
      <div>Income Total: <strong id="incomeTotal">$0.00</strong></div>
    </div>
  </section>

  <!-- Expenses (with sub-categories) -->
  <section class="card">
    <h2>Expenses (with sub-categories)</h2>
    <div class="inputs">
      <input id="expName" type="text" placeholder="Main category (e.g., Entertainment)">
      <input id="expAmt" type="number" placeholder="Amount (optional if using subs)" step="0.01" min="0">
      <input id="expColor" type="color" value="#F6A5A5">
      <button id="addExpense" class="btn-mint">Add Category</button>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Name</th><th>Color</th><th style="text-align:right">Amount</th><th style="text-align:right">Actions</th></tr></thead>
        <tbody id="expenseBody"></tbody>
      </table>
    </div>
    <div class="totalbar">
      <span class="muted">Use “Add Sub” on a category to add Netflix, Hulu, etc.</span>
      <div>Expense Total: <strong id="expenseTotal">$0.00</strong></div>
    </div>
  </section>

  <!-- Unified interactive donut -->
  <aside class="card pie-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
      <h2 style="margin:0">Income vs Expenses</h2>
      <button id="backBtn" class="back-btn" style="display:none">Back</button>
    </div>
    <canvas id="pie" width="740" height="740" aria-label="Interactive Budget Donut"></canvas>
    <div class="center-msg muted" id="centerMsg">Tap a slice to drill into sub-categories.</div>
  </aside>
</main>

<script>
/* ====== Utilities ====== */
const $ = (s) => document.querySelector(s);
const money = (n) => (isNaN(n) ? "$0.00" : n.toLocaleString(undefined,{style:'currency',currency:'USD'}));
const uid = () => Math.random().toString(36).slice(2,9);

/* ====== State ====== */
const LS_KEY = "bb-v4-saavr";
let state = {
  items: [] // {id, type:'income'|'expense', name, amount, color, subs?: [{id,name,amount}]}
};
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) state=JSON.parse(raw);}catch(e){} }

/* ====== Rendering: Tables ====== */
function makeEditableSpan(text, onCommit){
  const span=document.createElement('span');
  span.className='editable'; span.contentEditable=true; span.textContent=text;
  span.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); span.blur(); }});
  span.addEventListener('blur', ()=> onCommit(span.textContent.trim()));
  return span;
}

function parentAmount(item){
  if(item.subs && item.subs.length){
    return item.subs.reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
  }
  return parseFloat(item.amount)||0;
}

function makeIncomeRow(item){
  const tr=document.createElement('tr');
  tr.dataset.id=item.id;

  const tdName=document.createElement('td');
  tdName.appendChild(makeEditableSpan(item.name||'Untitled', v=>{ item.name=v||'Untitled'; renderAll(); save(); }));
  tr.appendChild(tdName);

  const tdColor=document.createElement('td');
  const picker=document.createElement('input'); picker.type='color'; picker.className='colorpick'; picker.value=item.color||'#50C3A3';
  picker.addEventListener('input',()=>{ item.color=picker.value; renderChart(); save(); });
  tdColor.appendChild(picker); tr.appendChild(tdColor);

  const tdAmt=document.createElement('td'); tdAmt.className='amount';
  const spanAmt=makeEditableSpan((parseFloat(item.amount)||0).toFixed(2), v=>{
    const n=parseFloat(v.replace(/[^\d.\-]/g,'')); item.amount=isNaN(n)?0:Math.max(0,n); spanAmt.textContent=item.amount.toFixed(2); renderTotals(); renderChart(); save();
  });
  tdAmt.appendChild(spanAmt); tr.appendChild(tdAmt);

  const tdAct=document.createElement('td'); tdAct.className='row-actions';
  const del=document.createElement('button'); del.textContent='Delete';
  del.addEventListener('click', ()=>{ state.items=state.items.filter(x=>x.id!==item.id); renderAll(); save(); });
  tdAct.appendChild(del); tr.appendChild(tdAct);

  return tr;
}

function makeExpenseRow(item){
  const tr=document.createElement('tr'); tr.dataset.id=item.id; tr.className='parent-row';

  const tdName=document.createElement('td');
  tdName.appendChild(makeEditableSpan(item.name||'Untitled', v=>{ item.name=v||'Untitled'; renderAll(); save(); }));
  tr.appendChild(tdName);

  const tdColor=document.createElement('td');
  const picker=document.createElement('input'); picker.type='color'; picker.className='colorpick'; picker.value=item.color||'#F6A5A5';
  picker.addEventListener('input',()=>{ item.color=picker.value; renderChart(); save(); });
  tdColor.appendChild(picker); tr.appendChild(tdColor);

  const tdAmt=document.createElement('td'); tdAmt.className='amount';
  const current = parentAmount(item);
  const spanAmt=makeEditableSpan((parseFloat(item.amount)||0).toFixed(2), v=>{
    const n=parseFloat(v.replace(/[^\d.\-]/g,''));
    // If category has subs, editing parent amount sets a "base" (optional), but total still sums subs.
    item.amount=isNaN(n)?0:Math.max(0,n);
    renderAll(); save();
  });
  // If subs exist, show computed total and smaller note
  tdAmt.innerHTML = '';
  const totalEl=document.createElement('div'); totalEl.textContent = money(current);
  const hint=document.createElement('div'); hint.className='muted'; hint.style.fontSize='12px';
  hint.textContent = item.subs && item.subs.length ? 'Sum of sub-categories' : 'Direct amount';
  tdAmt.appendChild(totalEl); tdAmt.appendChild(hint);
  tr.appendChild(tdAmt);

  const tdAct=document.createElement('td'); tdAct.className='row-actions';
  const addSub=document.createElement('button'); addSub.textContent='Add Sub';
  addSub.addEventListener('click', ()=>{
    item.subs = item.subs || [];
    item.subs.push({id:uid(), name:'New sub', amount:0});
    renderAll(); save();
  });
  const del=document.createElement('button'); del.textContent='Delete';
  del.addEventListener('click', ()=>{ state.items=state.items.filter(x=>x.id!==item.id); renderAll(); save(); });
  tdAct.appendChild(addSub); tdAct.appendChild(del); tr.appendChild(tdAct);

  return tr;
}

function makeSubRow(parent,item){
  const tr=document.createElement('tr'); tr.className='sub-row'; tr.dataset.id=item.id;
  // name
  const tdName=document.createElement('td');
  const rowWrap=document.createElement('div'); rowWrap.style.display='flex'; rowWrap.style.alignItems='center'; rowWrap.style.gap='8px';
  const dot=document.createElement('span'); dot.style.display='inline-block'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.background=parent.color||'#F6A5A5';
  rowWrap.appendChild(dot);
  rowWrap.appendChild(makeEditableSpan(item.name||'Sub', v=>{ item.name=v||'Sub'; renderAll(); save(); }));
  tdName.appendChild(rowWrap);
  tr.appendChild(tdName);
  // color cell (inherits; show disabled)
  const tdColor=document.createElement('td'); const lock=document.createElement('span'); lock.className='muted'; lock.textContent='—'; tdColor.appendChild(lock); tr.appendChild(tdColor);
  // amount
  const tdAmt=document.createElement('td'); tdAmt.className='amount';
  const spanAmt=makeEditableSpan((parseFloat(item.amount)||0).toFixed(2), v=>{
    const n=parseFloat(v.replace(/[^\d.\-]/g,'')); item.amount=isNaN(n)?0:Math.max(0,n);
    renderAll(); save();
  });
  tdAmt.appendChild(spanAmt); tr.appendChild(tdAmt);
  // actions
  const tdAct=document.createElement('td'); tdAct.className='row-actions';
  const del=document.createElement('button'); del.textContent='Delete';
  del.addEventListener('click', ()=>{
    parent.subs = (parent.subs||[]).filter(s=>s.id!==item.id);
    renderAll(); save();
  });
  tdAct.appendChild(del); tr.appendChild(tdAct);
  return tr;
}

function renderTables(){
  const incBody=$('#incomeBody'); const expBody=$('#expenseBody');
  incBody.innerHTML=''; expBody.innerHTML='';
  const incomes = state.items.filter(i=>i.type==='income');
  const expenses = state.items.filter(i=>i.type==='expense');

  // Income
  if(incomes.length===0){
    const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.innerHTML='<div class="muted">No income yet.</div>'; tr.appendChild(td); incBody.appendChild(tr);
  }else{ incomes.forEach(i=>incBody.appendChild(makeIncomeRow(i))); }

  // Expenses + subs
  if(expenses.length===0){
    const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.innerHTML='<div class="muted">No expenses yet.</div>'; tr.appendChild(td); expBody.appendChild(tr);
  }else{
    expenses.forEach(p=>{
      expBody.appendChild(makeExpenseRow(p));
      (p.subs||[]).forEach(s=> expBody.appendChild(makeSubRow(p,s)));
    });
  }
}

function sumBy(type){
  if(type==='income'){
    return state.items.filter(i=>i.type==='income').reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
  }
  if(type==='expense'){
    return state.items.filter(i=>i.type==='expense').reduce((a,b)=>a+parentAmount(b),0);
  }
  return 0;
}

function renderTotals(){
  $('#incomeTotal').textContent = money(sumBy('income'));
  $('#expenseTotal').textContent = money(sumBy('expense'));
}

/* ====== Unified Donut with Drill-Down ====== */
let pieCanvas, focusedCategoryId=null;

function drawDonut(){
  const c=pieCanvas, ctx=c.getContext('2d'); const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H/2;
  const outer=Math.min(W,H)/2 - 22;
  const inner=outer*0.58;
  const ringWidth=outer-inner;

  const incomes = state.items.filter(i=>i.type==='income' && (parseFloat(i.amount)||0)>0);
  const expenses = state.items.filter(i=>i.type==='expense');
  const incTotal = sumBy('income');
  const expTotal = sumBy('expense');

  // Base background ring
  ctx.beginPath(); ctx.arc(cx,cy,outer,0,Math.PI*2); ctx.lineWidth=ringWidth; ctx.strokeStyle='#2A3136'; ctx.stroke();

  // Income baseline ring (mint)
  if(incTotal>0){
    ctx.beginPath(); ctx.arc(cx,cy,outer,-Math.PI/2, -Math.PI/2 + Math.PI*2); ctx.lineWidth=ringWidth; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--mint') || '#50C3A3'; ctx.stroke();
  }

  const full = Math.PI*2;
  const spendAngle = incTotal>0 ? Math.min(1, expTotal/incTotal) * full : 0;

  // Build category totals
  const cats = expenses.map(cat => ({
    id: cat.id, name: cat.name, color: cat.color || '#F6A5A5',
    total: parentAmount(cat),
    subs: cat.subs||[]
  })).filter(c=>c.total>0);

  // Draw expense categories as segments across spendAngle
  let start = -Math.PI/2;
  const totalExp = cats.reduce((a,b)=>a+b.total,0) || 1;

  // If focusing, dim others and draw subs inside focused segment
  if(focusedCategoryId){
    const focused = cats.find(c=>c.id===focusedCategoryId);
    if(!focused){ focusedCategoryId=null; return drawDonut(); }

    // Draw all categories faintly
    for(const cat of cats){
      const ang = (cat.total/totalExp)*spendAngle;
      const end = start + ang;
      ctx.beginPath();
      ctx.arc(cx,cy,outer,start,end);
      ctx.arc(cx,cy,inner,end,start,true);
      ctx.closePath();
      ctx.fillStyle = cat.color + '88'; // translucent
      ctx.fill();
      // Highlight focused boundary
      if(cat.id===focusedCategoryId){
        // Draw subs as an inner ring (expand inside same angular span)
        const subs = focused.subs.filter(s=>(parseFloat(s.amount)||0)>0);
        const subsTotal = subs.reduce((a,b)=>a+(parseFloat(b.amount)||0),0) || 1;
        let sStart = start;
        const subOuter = inner + ringWidth*0.65;
        const subInner = inner + ringWidth*0.15;
        for(const sub of subs){
          const sAng = ((parseFloat(sub.amount)||0)/subsTotal) * ang;
          const sEnd = sStart + sAng;
          ctx.beginPath();
          ctx.arc(cx,cy,subOuter,sStart,sEnd);
          ctx.arc(cx,cy,subInner,sEnd,sStart,true);
          ctx.closePath();
          ctx.fillStyle = cat.color; // inherit
          ctx.fill();
          // separator
          ctx.beginPath();
          ctx.arc(cx,cy,(subOuter+subInner)/2, sEnd, sEnd+0.001);
          ctx.lineWidth = (subOuter - subInner);
          ctx.strokeStyle = '#00000030';
          ctx.stroke();
          sStart = sEnd;
        }
        // Strong overlay on focused outer arc
        ctx.beginPath();
        ctx.arc(cx,cy,outer,start,end);
        ctx.arc(cx,cy,inner,end,start,true);
        ctx.closePath();
        ctx.fillStyle = cat.color; ctx.globalAlpha=0.25; ctx.fill(); ctx.globalAlpha=1.0;
      }
      start = end;
    }

    // Center text: focused category total
    ctx.fillStyle='#c9f9ea';
    ctx.font='700 20px ui-sans-serif, system-ui, Segoe UI, Inter';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(`${focused.name}: ${money(focused.total)}`, cx, cy);

  } else {
    // Normal overview
    for(const cat of cats){
      const ang = (cat.total/totalExp)*spendAngle;
      const end = start + ang;
      ctx.beginPath();
      ctx.arc(cx,cy,outer,start,end);
      ctx.arc(cx,cy,inner,end,start,true);
      ctx.closePath();
      ctx.fillStyle = cat.color;
      ctx.fill();
      start = end;
    }

    // Center text: remaining / over
    const remaining = incTotal - expTotal;
    ctx.fillStyle = remaining>=0 ? '#c9f9ea' : '#ffd3d3';
    ctx.font='700 20px ui-sans-serif, system-ui, Segoe UI, Inter';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText( remaining>=0 ? (money(remaining)+' Remaining') : ('Over by '+money(Math.abs(remaining))), cx, cy );
  }

  // Overspend red indicator
  const remaining = incTotal - expTotal;
  if(remaining < 0 && incTotal>0){
    const over = Math.min(1, Math.abs(remaining)/incTotal);
    ctx.beginPath();
    ctx.arc(cx,cy, outer + 6, -Math.PI/2, -Math.PI/2 + over*full);
    ctx.lineWidth = 6;
    ctx.strokeStyle = '#FF6B6B';
    ctx.lineCap = 'round';
    ctx.stroke();
  }
}

// Hit-test to detect clicked category slice
function categoryFromPoint(x,y){
  const rect=pieCanvas.getBoundingClientRect();
  const px = (x - rect.left) * (pieCanvas.width/rect.width);
  const py = (y - rect.top) * (pieCanvas.height/rect.height);
  const cx=pieCanvas.width/2, cy=pieCanvas.height/2;
  const dx=px-cx, dy=py-cy;
  const r=Math.hypot(dx,dy);
  const outer=Math.min(pieCanvas.width,pieCanvas.height)/2 - 22;
  const inner=outer*0.58;

  if(r<inner || r>outer) return null; // outside ring

  const angle=Math.atan2(dy,dx); // -π..π
  let a = angle - (-Math.PI/2); if(a<0) a += Math.PI*2; // normalize to 0..2π from start

  const incTotal=sumBy('income'); const expTotal=sumBy('expense');
  const spendAngle = incTotal>0 ? Math.min(1, expTotal/incTotal) * Math.PI*2 : 0;
  if(a>spendAngle) return null; // clicked in remaining area

  // map through categories
  const expenses = state.items.filter(i=>i.type==='expense');
  const cats = expenses.map(cat => ({ id:cat.id, total:parentAmount(cat), color:cat.color||'#F6A5A5', name:cat.name })).filter(c=>c.total>0);
  const totalExp = cats.reduce((x,y)=>x+y.total,0) || 1;
  let accumulated=0;
  for(const cat of cats){
    const seg = (cat.total/totalExp)*spendAngle;
    if(a >= accumulated && a <= accumulated+seg){
      return cat.id;
    }
    accumulated += seg;
  }
  return null;
}

function renderChart(){ drawDonut(); }

/* ====== Wiring: UI ====== */
function renderAll(){ renderTables(); renderTotals(); renderChart(); }

function addIncome(){
  const nm=$('#incName').value.trim()||'Untitled';
  const amt=parseFloat($('#incAmt').value); const color=$('#incColor').value||'#50C3A3';
  state.items.push({id:uid(), type:'income', name:nm, amount:isNaN(amt)?0:Math.max(0,amt), color});
  $('#incName').value=''; $('#incAmt').value=''; $('#incName').focus();
  renderAll(); save();
}

function addExpense(){
  const nm=$('#expName').value.trim()||'Untitled';
  const amt=parseFloat($('#expAmt').value);
  const color=$('#expColor').value||'#F6A5A5';
  state.items.push({id:uid(), type:'expense', name:nm, amount:isNaN(amt)?0:Math.max(0,amt), color, subs:[]});
  $('#expName').value=''; $('#expAmt').value=''; $('#expName').focus();
  renderAll(); save();
}

function bind(){
  $('#addIncome').addEventListener('click', addIncome);
  $('#addExpense').addEventListener('click', addExpense);
  $('#resetBtn').addEventListener('click', ()=>{ if(confirm('Clear all data?')){ state.items=[]; focusedCategoryId=null; renderAll(); save(); }});
  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='budget_buddy_v4_backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  $('#importBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(obj && obj.items){ state=obj; focusedCategoryId=null; renderAll(); save(); } }catch(err){ alert('Invalid JSON.'); } };
    reader.readAsText(f); e.target.value='';
  });

  // Donut interactions
  $('#pie').addEventListener('click', (e)=>{
    const id = categoryFromPoint(e.clientX, e.clientY);
    if(id){
      focusedCategoryId = (focusedCategoryId===id? null : id);
      $('#backBtn').style.display = focusedCategoryId ? 'inline-block' : 'none';
      $('#centerMsg').textContent = focusedCategoryId ? 'Sub-categories view — tap Back or outside slice to exit.' : 'Tap a slice to drill into sub-categories.';
      renderChart();
    } else {
      // click outside: reset
      focusedCategoryId = null;
      $('#backBtn').style.display = 'none';
      $('#centerMsg').textContent = 'Tap a slice to drill into sub-categories.';
      renderChart();
    }
  });
  $('#backBtn').addEventListener('click', ()=>{
    focusedCategoryId=null; $('#backBtn').style.display='none';
    $('#centerMsg').textContent='Tap a slice to drill into sub-categories.';
    renderChart();
  });
}

/* ====== Init ====== */
window.addEventListener('DOMContentLoaded', ()=>{
  pieCanvas = $('#pie');
  load();
  if(!state.items || state.items.length===0){
    state.items = [
      {id:uid(), type:'income', name:'Paycheck', amount:3500, color:'#50C3A3'},
      {id:uid(), type:'income', name:'Side Hustle', amount:400, color:'#7ad8bf'},
      {id:uid(), type:'expense', name:'Entertainment', amount:0, color:'#7fc4ff', subs:[
        {id:uid(), name:'Netflix', amount:20},
        {id:uid(), name:'Hulu', amount:40},
        {id:uid(), name:'Spotify', amount:10}
      ]},
      {id:uid(), type:'expense', name:'Housing', amount:0, color:'#EF7D7D', subs:[
        {id:uid(), name:'Rent', amount:1200},
        {id:uid(), name:'Utilities', amount:220}
      ]},
      {id:uid(), type:'expense', name:'Groceries', amount:450, color:'#F6D365', subs:[]}
    ];
  }
  renderAll();
  bind();
});
</script>
</body>
</html>
